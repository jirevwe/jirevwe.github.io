<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Yes, you read that right. SQL does treat all NULLs as distinct values. I learnt this a while back while working on Convoy and again on LiteQueue: a Golang a queueing library.  Basically, any column wi">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL NULLs are Weird!">
<meta property="og:url" content="https://raymondtukpe.com/sql-nulls-are-weird.html">
<meta property="og:site_name" content="Raymond Tukpe">
<meta property="og:description" content="Yes, you read that right. SQL does treat all NULLs as distinct values. I learnt this a while back while working on Convoy and again on LiteQueue: a Golang a queueing library.  Basically, any column wi">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-01-05T11:54:41.000Z">
<meta property="article:modified_time" content="2025-01-15T18:48:40.075Z">
<meta property="article:author" content="Raymond Tukpe">
<meta property="article:tag" content="tech">
<meta property="article:tag" content="til">
<meta property="article:tag" content="interactive">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>SQL NULLs are Weird!</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- custom styles -->
    
<link rel="stylesheet" href="/css/custom.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="Raymond Tukpe" type="application/atom+xml" />
    
	<!-- mathjax -->
	
    <!-- codapi css -->
    <link rel="stylesheet" href="https://unpkg.com/@antonz/codapi@0.19.10/dist/snippet.css" />

    <!-- codapi sqlite   -->
    <script src="https://unpkg.com/@antonz/runno@0.6.1/dist/runno.js"></script>
    <script src="https://unpkg.com/@antonz/codapi@0.19.10/dist/engine/wasi.js"></script>

    <!-- codapi  -->
    <script src="https://unpkg.com/@antonz/codapi@0.19.10/dist/snippet.js"></script>

    <!-- code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const codeBlocks = document.querySelectorAll('code[contenteditable="true"]');

            codeBlocks.forEach(block => {
                // Handle blur event (clicking out of the block)
                block.addEventListener('blur', () => {
                    block.innerHTML = block.textContent;
                    Prism.highlightElement(block);
                });

                // Handle tab key
                block.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        document.execCommand('insertText', false, '    ');
                    }
                });
            });
        });
    </script>

    <!-- posthog analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2===o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug getPageViewId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('phc_MYiNjUsyl0OMMdquL3Q4DD99ZtLlgWToY0njcgrHBPB', {
            api_host:'https://us.i.posthog.com',
            person_profiles: 'always' // or 'always' to create profiles for anonymous users as well
        })
        posthog.capture('loaded', { property: document.location.userAgent });
    </script>
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Blog</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/partition-management-using-go-partman.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://raymondtukpe.com/sql-nulls-are-weird.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://raymondtukpe.com/sql-nulls-are-weird.html&text=SQL NULLs are Weird!"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://raymondtukpe.com/sql-nulls-are-weird.html&is_video=false&description=SQL NULLs are Weird!"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SQL NULLs are Weird!&body=Check out this article: https://raymondtukpe.com/sql-nulls-are-weird.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://raymondtukpe.com/sql-nulls-are-weird.html&name=SQL NULLs are Weird!&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://raymondtukpe.com/sql-nulls-are-weird.html&t=SQL NULLs are Weird!"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Establishing-a-baseline"><span class="toc-number">1.</span> <span class="toc-text">Establishing a baseline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-about-Uniqueness"><span class="toc-number">2.</span> <span class="toc-text">What about Uniqueness?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-does-this-happen"><span class="toc-number">3.</span> <span class="toc-text">Why does this happen?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-are-NULLs-handled-this-way"><span class="toc-number">4.</span> <span class="toc-text">Why are NULLs handled this way?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-then-can-we-ensure-uniqueness"><span class="toc-number">5.</span> <span class="toc-text">How then can we ensure uniqueness?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-a-generated-column"><span class="toc-number">5.1.</span> <span class="toc-text">Using a generated column</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-a-partial-index"><span class="toc-number">5.2.</span> <span class="toc-text">Using a partial index</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update"><span class="toc-number">6.</span> <span class="toc-text">Update</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">7.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        SQL NULLs are Weird!
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Raymond Tukpe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-01-05T11:54:41.000Z" itemprop="datePublished">2025-01-05</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/interactive/" rel="tag">interactive</a>, <a class="tag-link-link" href="/tags/tech/" rel="tag">tech</a>, <a class="tag-link-link" href="/tags/til/" rel="tag">til</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Yes, you read that right. SQL does treat all NULLs as distinct values. I learnt this a while back while working on <a target="_blank" rel="noopener" href="https://getconvoy.io/">Convoy</a> and again on <a target="_blank" rel="noopener" href="https://github.com/jirevwe/litequeue">LiteQueue</a>: a Golang a queueing library. </p>
<p>Basically, any column with a UNIQUE constraint can have multiple NULL values, because each NULL value is a distinct value that is different from other NULLs, and this is even less obvious if you’re used to using ORMs. I tested this with SQLite, Postgres and MYSQL and they all behave like this. Let’s prove this with some examples</p>
<h2 id="Establishing-a-baseline"><a href="#Establishing-a-baseline" class="headerlink" title="Establishing a baseline"></a>Establishing a baseline</h2><p>First, let’s establish a baseline to further highlight how this can be confusing. We’ll be comparing different values using the logical equals (“=”) operator and, even with basic programming experience, the results might not be what you expect:</p>
<pre><code class="lang-sql">select '' = '';    -- Returns 1 (true) because empty strings are equal
select 1 = 1;      -- Returns 1 (true) because the numbers are equal
select 1 = 0;      -- Returns 0 (false) because the numbers are different
select null = null; -- Returns NULL (null) because... wait what?</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<p><code>select null = null;</code> returns NULL, because each NULL is basically a placeholder representing any <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=cBw0c-cmOfc&t=13s">“unknown value”</a>. Two unknown values are not necessarily the same value; we can’t say that they are equal, because we don’t know the value of either of them. So it evaluates to an “unknown value” that’s obviously not “true” or “false”, which is why <code>NULL = NULL</code> returns <code>NULL</code>. Very weird, ikr! So now we’ve established that two NULL values in the same column are not considered equal using “=”; but we can use <code>IS</code>, because the <code>IS</code> operator checks for identity or rather if the type of both values are, well, NULL.</p>
<pre><code class="lang-sql">select null is null; -- Returns 1 (true) because IS checks for NULL identity</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<p>I’ll demonstrate this using one more example, which shows that NULL values are not equal to each other, but string values are (also applies to other values as well). The result will have all <code>equal_comparison</code> columns where two NULLs are compared to be NULL and all <code>is_comparison</code> columns where two NULLs are compared as 1; the string-to-string and string-to-null comparison results are pretty obvious. </p>
<pre><code class="lang-sql">drop table if exists sample;
CREATE TABLE if not exists sample (
     id INTEGER PRIMARY KEY, -- auto-increment
     name TEXT -- UNIQUE -- uncomment this line
);

INSERT INTO sample (name) VALUES (NULL), (NULL), ('test'); --, ('test');

SELECT
    a.id as id1,
    b.id as id2,
    coalesce(a.name, 'null') || ', ' || coalesce(b.name, 'null') as names,
    a.name = b.name as equal_comparison,
    a.name IS b.name as is_comparison
FROM sample a
    CROSS JOIN sample b -- creates an n by m loop on all the table's records.
WHERE a.id < b.id;</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<h2 id="What-about-Uniqueness"><a href="#What-about-Uniqueness" class="headerlink" title="What about Uniqueness?"></a>What about Uniqueness?</h2><p>Well, they’ll break based on “normal” reasoning so if you just pair two columns and expect it to work, I have bad news for you :D. First we create our schema we’ll use to test throughout this post and confirm that our table actually has the <code>UNIQUE</code> constraint.</p>
<pre><code class="lang-sql">drop table if exists sample;
create table if not exists sample (
    id TEXT primary key,
    email TEXT,
    deleted_at TEXT,
    UNIQUE(email, deleted_at)
) strict;

-- check to see if our constraint was actually defined as part of the table
SELECT sql FROM sqlite_schema WHERE name = 'sample';
</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<p>Then we’ll insert two records which normally should not be allowed to be inserted.</p>
<pre><code class="lang-sql">drop table if exists sample;
create table if not exists sample (
    id TEXT primary key,
    email TEXT,
    deleted_at TEXT,
    UNIQUE(email, deleted_at)
) strict;

insert into sample (id, email, deleted_at) values ('1', 'ray@mail.com', null);

-- This will not fail because the constraint doesn't hold
insert into sample (id, email, deleted_at) values ('2', 'ray@mail.com', null);

-- check the content of the sample table
select * from sample;</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<p>If you ran the snippets you can see that both rows were actually inserted into the table and that the constraint was actually defined in the table. So now we have three questions:</p>
<ol>
<li>Why does this happen?</li>
<li>Why are NULLs handled this way?</li>
<li>How then can we ensure uniqueness?</li>
</ol>
<h2 id="Why-does-this-happen"><a href="#Why-does-this-happen" class="headerlink" title="Why does this happen?"></a>Why does this happen?</h2><p>Well, the two rows are actually unique! The first row <code>(&#39;ray@mail.com&#39;, NULL)</code> and the second row <code>(&#39;ray@mail.com&#39;, NULL)</code> are not the same because the NULL values, as we established earlier, are different.</p>
<h2 id="Why-are-NULLs-handled-this-way"><a href="#Why-are-NULLs-handled-this-way" class="headerlink" title="Why are NULLs handled this way?"></a>Why are NULLs handled this way?</h2><p>According to the <a target="_blank" rel="noopener" href="https://www.sqlite.org/nulls.html">SQLite docs</a>, SQLite, and other SQL compliant databases were implemented like this to handle NULLs in line with how other databases implement NULLs. Apparently none of them follow the SQL standards specification ——if only we could read (or refer) it, I’ll comment on this at the end. Here’s a quote from the <a target="_blank" rel="noopener" href="https://www.sqlite.org/nulls.html">SQLite docs</a>:</p>
<blockquote>
<p>The fact that NULLs are distinct for UNIQUE columns but are indistinct for SELECT DISTINCT and UNION continues to be puzzling. It seems that NULLs should be either distinct everywhere or nowhere. And the SQL standards documents suggest that NULLs should be distinct everywhere. Yet as of this writing, no SQL engine tested treats NULLs as distinct in a SELECT DISTINCT statement or in a UNION.</p>
</blockquote>
<p>The <code>UNIQUE(email, deleted_at)</code> constraint ensures no two rows have the same combination of email and deleted_at, but it allows multiple rows with the same email as long as <code>deleted_at</code> differs.</p>
<h2 id="How-then-can-we-ensure-uniqueness"><a href="#How-then-can-we-ensure-uniqueness" class="headerlink" title="How then can we ensure uniqueness?"></a>How then can we ensure uniqueness?</h2><p>We’ll explore two ways to mitigate this.</p>
<h3 id="Using-a-generated-column"><a href="#Using-a-generated-column" class="headerlink" title="Using a generated column"></a>Using a generated column</h3><p>To mitigate against the issue of NULLs not being a deterministic value we can create another field that always has a deterministic value. It will be a generated column that’s set ON INSERT and ON UPDATE. We can define that field thus:</p>
<pre><code class="lang-sql">CREATE TABLE sample (
    id TEXT PRIMARY KEY,
    email TEXT,
    deleted_at TEXT, -- nullable
    _deleted_at_coalesced TEXT GENERATED ALWAYS 
        AS (COALESCE(deleted_at, '1970-01-01')) STORED, -- not nullable
    UNIQUE(email, _deleted_at_coalesced)
) STRICT;</code></pre>

<p>The new field <code>_deleted_at_coalesced</code> will be set to <code>&#39;1970-01-01&#39;</code> whenever <code>deleted_at</code> is <code>NULL</code>. This leads to an extra field making your table wider and larger (because the extra field takes space) which might be negligible for a small table but with millions of rows, that extra field’s existence uses up more space. </p>
<p>Let’s test a full example using the generated field, you can play around with it adding <code>select * from sample;</code> after each line to see the steps.</p>
<pre><code class="lang-sql">drop table if exists sample;
CREATE TABLE sample (
    id TEXT PRIMARY KEY,
    email TEXT,
    deleted_at TEXT, 
    _deleted_at_coalesced TEXT GENERATED ALWAYS AS (COALESCE(deleted_at, '1970-01-01')) STORED, 
    UNIQUE(email, _deleted_at_coalesced)
) STRICT;

insert into sample (id, email, deleted_at) values ('1', 'ray@mail.com', null);

-- This will fail due to because of the constraint on the email and the generated column. Uncomment it to test it out
-- insert into sample (id, email, deleted_at) values ('2', 'ray@mail.com', null);

insert into sample (id, email, deleted_at) values ('3', 'ray@mail.com', '2024-11-12T00:00:00.000Z');

insert into sample (id, email, deleted_at) values ('4', 'ray@mail.com', '2024-11-11T01:00:00.000Z');

insert into sample (id, email, deleted_at) values ('6', 'different@mail.com', null);

update sample set deleted_at = '2024-11-11T02:00:00.000Z' where deleted_at is null;

insert into sample (id, email, deleted_at) values ('7', 'different@mail.com', null);

update sample set deleted_at = '2024-11-11T03:00:00.000Z' where deleted_at is null;

insert into sample (id, email, deleted_at) values ('8', 'different@mail.com', null);

select * from sample;</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<p>While this works, there’s a flaw. Deleting the same record twice (basically when the tuple exists already) won’t work. Let’s test this.</p>
<pre><code class="lang-sql">drop table if exists sample;
CREATE TABLE sample (
    id TEXT PRIMARY KEY,
    email TEXT,
    deleted_at TEXT, 
    _deleted_at_coalesced TEXT GENERATED ALWAYS AS (COALESCE(deleted_at, '1970-01-01')) STORED, 
    UNIQUE(email, _deleted_at_coalesced)
) STRICT;

insert into sample (id, email, deleted_at) values ('1', 'ray@mail.com', null);

update sample set deleted_at = '2024-11-11T03:00:00.000Z' where id is 1;

insert into sample (id, email, deleted_at) values ('2', 'ray@mail.com', null);

select * from sample;

-- This will fail due to because of the email and generated column tuple already exists. Uncomment it to test it out
-- update sample set deleted_at = '2024-11-11T03:00:00.000Z' where id is 2;</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<h3 id="Using-a-partial-index"><a href="#Using-a-partial-index" class="headerlink" title="Using a partial index"></a>Using a partial index</h3><p>Now let’s explore a proper solution to the problem. Indexes also take up space, the size of which you can estimate in the database of your choice. Indexes also impact insert times, they are majorly influenced by how many indexes exist on the table and the combination of keys in those indexes. So use them wisely! </p>
<p>We’re going to be using a partial index on <code>email</code> where the <code>deleted_at</code> field is <code>NULL</code>.</p>
<pre><code class="lang-sql">CREATE UNIQUE INDEX if not exists idx_sample_email_deleted_at
    ON sample(email) WHERE deleted_at IS NULL;</code></pre>

<p>Let’s test it now, we’ll insert some records, update them and insert similar conflicting records.</p>
<pre><code class="lang-sql">drop table if exists sample;
create table if not exists sample (
    id TEXT primary key,
    email TEXT,
    deleted_at TEXT
) strict;

CREATE UNIQUE INDEX if not exists idx_sample_email_deleted_at
    ON sample(email) WHERE deleted_at IS NULL;

insert into sample (id, email, deleted_at) values ('1', 'ray@mail.com', null);

-- This will fail due to idx_sample_email_deleted_at, uncomment it to test it out
-- insert into sample (id, email, deleted_at) values ('2', 'ray@mail.com', null);

insert into sample (id, email, deleted_at) values ('3', 'ray@mail.com', '2024-11-12T00:00:00.000Z');

insert into sample (id, email, deleted_at) values ('4', 'ray@mail.com', '2024-11-11T01:00:00.000Z');

insert into sample (id, email, deleted_at) values ('6', 'different@mail.com', null);

update sample set deleted_at = '2024-11-11T02:00:00.000Z' where deleted_at is null;

insert into sample (id, email, deleted_at) values ('7', 'different@mail.com', null);

update sample set deleted_at = '2024-11-11T03:00:00.000Z' where deleted_at is null;

insert into sample (id, email, deleted_at) values ('8', 'different@mail.com', null);

select * from sample;</code></pre>
<p><codapi-snippet engine="wasi" sandbox="sqlite" editor="basic"></codapi-snippet></p>
<p>Using a partial index is the best way to ensure the unique constraint is held without making your table wider, managing an extra field, it consumes less space and isn’t (AS) error-prone when deleting the same record pair over and over again! </p>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/13278879">Oracle treats empty strings as NULL for some reason</a>, welp!</li>
<li>Relevant HN discussion: <a target="_blank" rel="noopener" href="https://news.ycombinator.com/item?id=42645110">https://news.ycombinator.com/item?id=42645110</a></li>
<li>Relevant discussion on Reddit r/programming: <a target="_blank" rel="noopener" href="https://www.reddit.com/r/programming/comments/1hxi1tg/sql_nulls_are_weird/">https://www.reddit.com/r/programming/comments/1hxi1tg/sql_nulls_are_weird/</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>While this might seem trivial to experienced engineers and invisible when you use an ORM; it’s often overlooked and can lead to confusion if you don’t know how it works. Another fun thing I discovered is that the SQL standard document (think HTTP RFC but for SQL) isn’t publicly available, but can be procured for a fee.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://news.ycombinator.com/item?id=35567708">https://news.ycombinator.com/item?id=35567708</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/21813895/where-can-i-find-sql-language-specification">https://stackoverflow.com/questions/21813895/where-can-i-find-sql-language-specification</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Blog</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Establishing-a-baseline"><span class="toc-number">1.</span> <span class="toc-text">Establishing a baseline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-about-Uniqueness"><span class="toc-number">2.</span> <span class="toc-text">What about Uniqueness?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-does-this-happen"><span class="toc-number">3.</span> <span class="toc-text">Why does this happen?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-are-NULLs-handled-this-way"><span class="toc-number">4.</span> <span class="toc-text">Why are NULLs handled this way?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-then-can-we-ensure-uniqueness"><span class="toc-number">5.</span> <span class="toc-text">How then can we ensure uniqueness?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-a-generated-column"><span class="toc-number">5.1.</span> <span class="toc-text">Using a generated column</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-a-partial-index"><span class="toc-number">5.2.</span> <span class="toc-text">Using a partial index</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update"><span class="toc-number">6.</span> <span class="toc-text">Update</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">7.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://raymondtukpe.com/sql-nulls-are-weird.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://raymondtukpe.com/sql-nulls-are-weird.html&text=SQL NULLs are Weird!"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://raymondtukpe.com/sql-nulls-are-weird.html&is_video=false&description=SQL NULLs are Weird!"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SQL NULLs are Weird!&body=Check out this article: https://raymondtukpe.com/sql-nulls-are-weird.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://raymondtukpe.com/sql-nulls-are-weird.html&title=SQL NULLs are Weird!"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://raymondtukpe.com/sql-nulls-are-weird.html&name=SQL NULLs are Weird!&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://raymondtukpe.com/sql-nulls-are-weird.html&t=SQL NULLs are Weird!"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2025
    Raymond Tukpe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Blog</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WBT5Z15WML"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WBT5Z15WML');
    </script>

<!-- Mix Panel -->

  <script type="text/javascript">
    (function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(".");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;"undefined"!==typeof c?a=b[c]=[]:c="mixpanel";a.people=a.people||[];a.toString=function(a){var d="mixpanel";"mixpanel"!==c&&(d+="."+c);a||(d+=" (stub)");return d};a.people.toString=function(){return a.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
    for(h=0;h<i.length;h++)g(a,i[h]);var j="set set_once union unset remove delete".split(" ");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e,call2])}}for(var d={},e=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<j.length;c++)b(j[c]);return d};b._i.push([e,f,c])};b.__SV=1.2;e=f.createElement("script");e.type="text/javascript";e.async=!0;e.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?
    MIXPANEL_CUSTOM_LIB_URL:"file:"===f.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";g=f.getElementsByTagName("script")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);
    
    // Enabling the debug mode flag is useful during implementation,
    // but it's recommended you remove it for production
    mixpanel.init('9610491ecd39092940c531190faae9e7', {ignore_dnt: true}); 
    mixpanel.track('Viewed'); 
    </script>
    

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
